{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://envoi.local/schemas/task.schema.json",
  "title": "Envoi Task",
  "type": "object",
  "additionalProperties": false,
  "required": ["task_id", "milestone_id", "task_kind", "intent", "scope", "diff_limits", "verification"],
  "properties": {
    "task_id": { "type": "string", "minLength": 1, "maxLength": 80 },
    "milestone_id": { "type": "string", "minLength": 1, "maxLength": 80 },
    "task_kind": { "type": "string", "enum": ["execute", "verify_only", "question"] },
    "intent": { "type": "string", "minLength": 1, "maxLength": 1200 },
    "question": {
      "type": "object",
      "additionalProperties": false,
      "required": ["prompt"],
      "properties": {
        "prompt": { "type": "string", "minLength": 1, "maxLength": 2000 },
        "choices": {
          "type": "array",
          "items": { "type": "string", "minLength": 1, "maxLength": 200 },
          "minItems": 0,
          "maxItems": 12
        }
      }
    },
    "scope": {
      "type": "object",
      "additionalProperties": false,
      "required": ["allowed_globs", "forbidden_globs", "allow_new_files", "allow_lockfile_changes"],
      "properties": {
        "allowed_globs": {
          "type": "array",
          "items": { "type": "string", "minLength": 1, "maxLength": 200 },
          "minItems": 1,
          "maxItems": 64
        },
        "forbidden_globs": {
          "type": "array",
          "items": { "type": "string", "minLength": 1, "maxLength": 200 },
          "minItems": 0,
          "maxItems": 64
        },
        "allow_new_files": { "type": "boolean" },
        "allow_lockfile_changes": { "type": "boolean" }
      }
    },
    "diff_limits": {
      "type": "object",
      "additionalProperties": false,
      "required": ["max_files_touched", "max_lines_changed"],
      "properties": {
        "max_files_touched": { "type": "integer", "minimum": 1, "maximum": 500 },
        "max_lines_changed": { "type": "integer", "minimum": 1, "maximum": 20000 }
      }
    },
    "verification": {
      "type": "object",
      "additionalProperties": false,
      "required": ["fast", "slow"],
      "properties": {
        "fast": {
          "type": "array",
          "items": { "type": "string", "minLength": 1, "maxLength": 64 },
          "minItems": 0,
          "maxItems": 16
        },
        "slow": {
          "type": "array",
          "items": { "type": "string", "minLength": 1, "maxLength": 64 },
          "minItems": 0,
          "maxItems": 16
        },
        "params": {
          "type": "object",
          "additionalProperties": {
            "type": "object",
            "additionalProperties": {
              "type": ["string", "number", "boolean", "null"]
            }
          }
        }
      }
    },
    "builder": {
      "type": "object",
      "additionalProperties": false,
      "required": ["mode", "max_turns", "instructions"],
      "properties": {
        "mode": { "type": "string", "enum": ["cursor"] },
        "max_turns": { "type": "integer", "minimum": 1, "maximum": 40 },
        "instructions": { "type": "string", "minLength": 1, "maxLength": 4000 }
      }
    },
    "control": {
      "type": "object",
      "additionalProperties": false,
      "required": ["action"],
      "properties": {
        "action": { "type": "string", "enum": ["continue", "stop"] },
        "reason": { "type": "string", "maxLength": 400 }
      }
    },
    "planning_decision": {
      "type": "object",
      "additionalProperties": false,
      "required": ["idea_ids_considered", "decision", "rationale_short"],
      "properties": {
        "idea_ids_considered": {
          "type": "array",
          "items": { "type": "string", "minLength": 1, "maxLength": 120 },
          "minItems": 0,
          "maxItems": 50
        },
        "decision": {
          "type": "string",
          "enum": ["schedule_now", "schedule_next", "defer"]
        },
        "rationale_short": { "type": "string", "minLength": 1, "maxLength": 600 },
        "suggested_milestone": { "type": "string", "minLength": 1, "maxLength": 80 }
      }
    }
  },
  "allOf": [
    {
      "if": { "properties": { "task_kind": { "const": "question" } } },
      "then": {
        "required": ["question", "control"],
        "properties": {
          "control": {
            "properties": { "action": { "const": "stop" } }
          }
        },
        "not": { "required": ["builder"] }
      }
    }
  ],
  "oneOf": [
    {
      "required": ["control"],
      "not": { "required": ["builder"] }
    },
    {
      "required": ["builder"],
      "not": { "required": ["control"] }
    }
  ]
}
