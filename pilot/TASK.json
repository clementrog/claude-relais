{
  "v": 5,
  "id": "WP-045",
  "milestone": "M5",
  "goal": "Implement rollback to restore repo to base_commit state after STOP",

  "context": {
    "why": "When Judge detects a violation (scope, diff limits, etc.), the repo must be rolled back to the base_commit state. This resets tracked files and removes only the untracked files that were touched by the builder.",
    "deps": ["WP-040"],
    "extract": "From PRD Appendix B: Rollback steps: 1) git reset --hard <base_commit>, 2) Remove untracked touched paths captured by the runner (only those paths). Rollback is mandatory on any STOP after builder ran."
  },

  "subtasks": [
    "1. Create src/lib/rollback.ts module for rollback functions",
    "2. Create RollbackResult interface with success, errors, paths_removed",
    "3. Implement rollbackTracked(baseCommit): git reset --hard <base_commit>",
    "4. Implement removeUntrackedPaths(paths): remove specific untracked files",
    "5. Implement rollback(baseCommit, untrackedPaths): full rollback operation",
    "6. Handle errors gracefully (file already removed, permission issues)",
    "7. Export from src/lib/index.ts"
  ],

  "implementation": {
    "RollbackResult_interface": {
      "success": "boolean - true if rollback completed",
      "tracked_reset": "boolean - whether git reset succeeded",
      "paths_removed": "string[] - untracked paths that were removed",
      "errors": "string[] - any errors encountered"
    },
    "git_commands": {
      "reset_tracked": "git reset --hard <base_commit>",
      "verify_clean": "git status --porcelain (should be empty after rollback)"
    },
    "untracked_removal": "Use fs.unlink for files, fs.rm with recursive for directories"
  },

  "scope": {
    "write": ["src/lib/rollback.ts", "src/lib/index.ts"],
    "create_under": ["src/lib/"],
    "read_forbidden": [".env*", "*.pem", "*.key"],
    "forbidden": ["pilot/*", "relais/*", "package.json"]
  },

  "acceptance": [
    "rollbackTracked resets tracked files to base_commit",
    "removeUntrackedPaths removes only specified paths",
    "rollback combines both operations correctly",
    "Errors are captured, not thrown",
    "RollbackResult reports what was done",
    "pnpm build succeeds"
  ],

  "verify": ["pnpm build"],
  "risk": "MED",
  "notes": [
    "Only remove paths that were touched (captured from diff analysis)",
    "Don't blindly delete all untracked files - only builder-touched ones",
    "Use execSync for git commands (synchronous is fine for rollback)"
  ]
}
