{
  "v": 5,
  "id": "WP-031",
  "milestone": "M4",
  "goal": "Add schema validation for builder results using Ajv",

  "context": {
    "why": "Builder output should validate against builder_result.schema.json. When strict_builder_json=true, invalid output causes STOP_BUILDER_OUTPUT_INVALID.",
    "deps": ["WP-022", "WP-030"],
    "extract": "From PRD Section 9: Builder output must output ONLY a JSON object matching builder_result.schema.json. If builder output is malformed and config requires strict, runner STOP(builder_output_invalid)."
  },

  "subtasks": [
    "1. Update runBuilder to validate output against builder_result.schema.json",
    "2. Use validateWithSchema from src/lib/schema.ts",
    "3. Handle strict_builder_json config option",
    "4. When strict and invalid: set builderOutputValid=false, return error",
    "5. When lenient and invalid: continue but mark builderOutputValid=false",
    "6. Update BuilderInvocationResult to include validation errors"
  ],

  "implementation": {
    "validation_flow": [
      "1. Try to parse response as JSON",
      "2. If parse fails: builderOutputValid=false",
      "3. If parse succeeds: validate against schema",
      "4. If schema validation fails: builderOutputValid=false",
      "5. If strict_builder_json=true AND invalid: return error immediately",
      "6. If strict_builder_json=false AND invalid: continue with null result"
    ],
    "BuilderInvocationResult_update": {
      "validationErrors": "string[] - schema validation errors if any"
    },
    "schema_path": "relais/schemas/builder_result.schema.json"
  },

  "scope": {
    "write": ["src/runner/builder.ts"],
    "create_under": [],
    "read_forbidden": [".env*", "*.pem", "*.key"],
    "forbidden": ["pilot/*", "relais/*", "package.json"]
  },

  "acceptance": [
    "Builder output is validated against builder_result.schema.json",
    "strict_builder_json=true causes failure on invalid output",
    "strict_builder_json=false allows invalid output with warning",
    "Validation errors are included in BuilderInvocationResult",
    "pnpm build succeeds"
  ],

  "verify": ["pnpm build"],
  "risk": "LOW",
  "notes": [
    "Reuse validateWithSchema from WP-022",
    "Default strict_builder_json=false per config"
  ]
}
