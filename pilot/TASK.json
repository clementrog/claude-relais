{
  "v": 5,
  "id": "WP-022",
  "milestone": "M3",
  "goal": "Add JSON Schema validation for TASK.json using Ajv",

  "context": {
    "why": "PRD requires that orchestrator output validates against task.schema.json. Using Ajv provides robust validation with clear error messages.",
    "deps": ["WP-021"],
    "extract": "From PRD: Orchestrator output MUST be a single JSON object that validates against task.schema.json. If invalid, runner retries once with appended retry_reason."
  },

  "subtasks": [
    "1. Install ajv as a dependency (pnpm add ajv)",
    "2. Create src/lib/schema.ts with loadSchema and validateWithSchema functions",
    "3. Load task.schema.json from relais/schemas/",
    "4. Update orchestrator.ts to use Ajv validation instead of basic validation",
    "5. Return detailed validation errors for debugging",
    "6. Export from index files"
  ],

  "implementation": {
    "loadSchema": {
      "signature": "async function loadSchema(schemaPath: string): Promise<object>",
      "behavior": "Load and parse JSON schema file"
    },
    "validateWithSchema": {
      "signature": "function validateWithSchema<T>(data: unknown, schema: object): ValidationResult<T>",
      "behavior": "Validate data against schema, return typed result or errors"
    },
    "ValidationResult": {
      "valid": "boolean",
      "data": "T | null - typed data if valid",
      "errors": "string[] - validation error messages"
    },
    "integration": {
      "note": "Update parseTaskFromResponse in orchestrator.ts to use validateWithSchema"
    }
  },

  "scope": {
    "write": ["src/runner/orchestrator.ts"],
    "create_under": ["src/lib"],
    "read_forbidden": [".env*", "*.pem", "*.key"],
    "forbidden": ["pilot/*", "relais/*"]
  },

  "acceptance": [
    "ajv is installed as dependency",
    "src/lib/schema.ts exists with loadSchema and validateWithSchema",
    "orchestrator.ts uses Ajv for task validation",
    "Invalid tasks return clear error messages",
    "pnpm build succeeds"
  ],

  "verify": ["pnpm install", "pnpm build"],
  "risk": "MED",
  "notes": [
    "Use ajv with draft-2020-12 support",
    "Cache compiled schema for performance"
  ]
}
