{
  "v": 5,
  "id": "WP-023",
  "milestone": "M3",
  "goal": "Implement orchestrator parse retry logic (1 retry on invalid JSON)",

  "context": {
    "why": "PRD allows one retry if orchestrator outputs invalid JSON/schema. The retry includes the error reason in the prompt.",
    "deps": ["WP-021", "WP-022"],
    "extract": "From PRD Section 8: If invalid, runner retries once with appended retry_reason. If still invalid â†’ BLOCKED(orchestrator_output_invalid)."
  },

  "subtasks": [
    "1. Update runOrchestrator to support retry with reason",
    "2. Add retry_reason parameter to prompt building",
    "3. Track retry attempt count (max 1 retry)",
    "4. Return BLOCKED_ORCHESTRATOR_OUTPUT_INVALID after failed retry",
    "5. Log retry attempts for debugging"
  ],

  "implementation": {
    "runOrchestrator_update": {
      "behavior": [
        "1. First attempt: call orchestrator normally",
        "2. If JSON parse fails or schema validation fails:",
        "   a. If no retry yet: build retry prompt with error reason",
        "   b. Call orchestrator again with retry prompt",
        "3. If second attempt also fails: return BLOCKED_ORCHESTRATOR_OUTPUT_INVALID",
        "4. Track attempts in OrchestratorResult"
      ]
    },
    "OrchestratorResult_update": {
      "add_fields": {
        "attempts": "number - how many orchestrator calls made (1 or 2)",
        "retryReason": "string | null - the error that triggered retry"
      }
    },
    "retry_prompt_format": {
      "note": "Append to user prompt:",
      "format": "\\n\\n=== RETRY ===\\nYour previous output was invalid: {{RETRY_REASON}}\\nPlease output ONLY valid JSON matching the schema."
    }
  },

  "scope": {
    "write": ["src/runner/orchestrator.ts"],
    "create_under": [],
    "read_forbidden": [".env*", "*.pem", "*.key"],
    "forbidden": ["pilot/*", "relais/*", "package.json"]
  },

  "acceptance": [
    "runOrchestrator retries once on invalid output",
    "Retry prompt includes the error reason",
    "Returns BLOCKED_ORCHESTRATOR_OUTPUT_INVALID after second failure",
    "OrchestratorResult includes attempts count",
    "pnpm build succeeds"
  ],

  "verify": ["pnpm build"],
  "risk": "LOW",
  "notes": [
    "Keep retry logic simple - just one retry",
    "Error reason should be concise but helpful"
  ]
}
