{
  "v": 5,
  "id": "WP-076",
  "milestone": "M8",
  "goal": "Add doctor checks for Codex CLI reviewer",

  "context": {
    "why": "The 'relais doctor' command should verify Codex CLI availability and auth status so users know if reviewer feature will work.",
    "deps": ["WP-075"],
    "extract": "From PRD Appendix C3: Doctor checks codex --version, auth status (api_key_present or chatgpt_login_ok), prints reviewer mode (enabled/disabled, auth mode)."
  },

  "subtasks": [
    "1. Add checkCodexCli() function to src/lib/doctor.ts",
    "2. Check 'codex --version' succeeds (CLI available)",
    "3. Check CODEX_API_KEY env var presence for auth status",
    "4. Add ReviewerDoctorResult type with cli_available, auth_status fields",
    "5. Integrate into existing doctor checks",
    "6. Export from src/lib/index.ts"
  ],

  "implementation": {
    "checks": {
      "cli_available": "spawn codex --version, check exit code 0",
      "auth_status": "api_key_present if CODEX_API_KEY set, else unknown (best-effort)",
      "reviewer_mode": "Read from config: enabled, auth.mode"
    },
    "output": {
      "success": "✓ codex cli: available (vX.X.X)",
      "auth_ok": "✓ codex auth: api_key_present",
      "auth_missing": "✗ codex auth: missing (run 'codex login' or set CODEX_API_KEY)",
      "disabled": "○ reviewer: disabled"
    }
  },

  "scope": {
    "write": ["src/lib/doctor.ts", "src/lib/index.ts"],
    "create_under": [],
    "read_forbidden": [".env*", "*.pem", "*.key"],
    "forbidden": ["pilot/*", "relais/*", "tests/**"]
  },

  "acceptance": [
    "checkCodexCli returns ReviewerDoctorResult",
    "CLI check spawns 'codex --version' with shell:false",
    "Auth check reads CODEX_API_KEY from process.env",
    "Results include cli_available, auth_status, version fields",
    "pnpm build succeeds"
  ],

  "verify": ["pnpm build"],
  "risk": "LOW",
  "notes": [
    "Auth check is best-effort - only env var presence",
    "If codex CLI not found, reviewer features degrade gracefully"
  ]
}
