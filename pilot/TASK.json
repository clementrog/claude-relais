{
  "v": 5,
  "id": "WP-020",
  "milestone": "M3",
  "goal": "Create Claude Code CLI wrapper for invoking claude with proper flags",

  "context": {
    "why": "Relais invokes Claude Code CLI in non-interactive mode with specific flags. Need a clean wrapper to handle invocation, output parsing, and error handling.",
    "deps": ["WP-010"],
    "extract": "From PRD: claude -p --output-format json --max-turns N --no-session-persistence --permission-mode MODE --model MODEL --allowedTools TOOLS. Parse stdout JSON, then parse stdout_json.result as the actual model text."
  },

  "subtasks": [
    "1. Create src/types/claude.ts with ClaudeInvocation, ClaudeResponse, ClaudeError types",
    "2. Create src/lib/claude.ts with invokeClaudeCode function",
    "3. Implement buildClaudeArgs() to construct CLI arguments",
    "4. Implement parseClaudeResponse() to extract result from JSON wrapper",
    "5. Add timeout handling and process management",
    "6. Export from index files"
  ],

  "implementation": {
    "ClaudeInvocation": {
      "prompt": "string - the prompt to send",
      "maxTurns": "number - max agentic turns",
      "permissionMode": "'plan' | 'bypassPermissions'",
      "model": "string - model alias or full name",
      "allowedTools": "string | undefined - comma-separated tool list",
      "systemPrompt": "string | undefined - system prompt file path",
      "timeout": "number - timeout in ms"
    },
    "ClaudeResponse": {
      "success": "boolean",
      "result": "string | null - the model's text output",
      "raw": "object - full JSON response",
      "exitCode": "number",
      "durationMs": "number"
    },
    "invokeClaudeCode": {
      "signature": "async function invokeClaudeCode(config: ClaudeCodeCliConfig, invocation: ClaudeInvocation): Promise<ClaudeResponse>",
      "behavior": [
        "1. Build args array from config + invocation",
        "2. Spawn process with timeout",
        "3. Capture stdout/stderr",
        "4. Parse JSON wrapper from stdout",
        "5. Extract .result field as model output",
        "6. Return ClaudeResponse with parsed data"
      ]
    },
    "CLI_FLAGS": {
      "-p": "prompt mode (non-interactive)",
      "--output-format": "json",
      "--max-turns": "from invocation",
      "--no-session-persistence": "always",
      "--permission-mode": "plan or bypassPermissions",
      "--model": "from invocation",
      "--allowedTools": "from invocation (optional)",
      "--system-prompt": "from invocation (optional)"
    }
  },

  "scope": {
    "write": [],
    "create_under": ["src/types", "src/lib"],
    "read_forbidden": [".env*", "*.pem", "*.key"],
    "forbidden": ["pilot/*", "relais/*", "package.json"]
  },

  "acceptance": [
    "src/types/claude.ts exists with ClaudeInvocation, ClaudeResponse types",
    "src/lib/claude.ts exists with invokeClaudeCode function",
    "buildClaudeArgs returns correct CLI flags",
    "parseClaudeResponse extracts .result from JSON wrapper",
    "Timeout handling works correctly",
    "pnpm build succeeds"
  ],

  "verify": ["pnpm build"],
  "risk": "MED",
  "notes": [
    "Use child_process.spawn for process management",
    "The JSON wrapper has format: { result: 'model output', ... }",
    "Handle both successful completion and timeout/error cases"
  ]
}
