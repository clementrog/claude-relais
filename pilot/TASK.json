{
  "v": 5,
  "id": "WP-083",
  "milestone": "M9",
  "goal": "Implement guardrail preflight checks",

  "context": {
    "why": "Before running verify commands, preflight must validate branch match, fingerprint match, and worktree clean status to catch problems early.",
    "deps": ["WP-082"],
    "extract": "From Guardrails spec RUN-01: git branch must equal STATE.branch, worktree must be clean, TASK fingerprint must match STATE.task_fingerprint. If any fails -> STOP with dedicated code."
  },

  "subtasks": [
    "1. Create src/lib/guardrails.ts with runGuardrailPreflight function",
    "2. Implement checkBranchMatch(state) -> ok or STOP_BRANCH_MISMATCH",
    "3. Implement checkFingerprintMatch(state, task) -> ok or STOP_REDISPATCH_IDENTICAL_TASK",
    "4. Implement checkWorktreeClean() -> ok or appropriate STOP code",
    "5. Combine checks into preflightChecks(state, task, config) -> PreflightResult",
    "6. Export from src/lib/index.ts"
  ],

  "implementation": {
    "functions": {
      "checkBranchMatch": "Compare git branch --show-current with STATE.branch",
      "checkFingerprintMatch": "Compare computeFingerprint(task) with STATE.task_fingerprint and last_failed_fingerprint",
      "checkWorktreeClean": "Run git status --porcelain, check empty (or only allowed ephemeral files)",
      "runGuardrailPreflight": "Run all checks, return first failure or OK"
    },
    "return_type": "PreflightResult = { ok: boolean, stopCode?: StopCode, reason?: string }"
  },

  "scope": {
    "write": ["src/lib/guardrails.ts", "src/lib/index.ts"],
    "create_under": ["src/lib/"],
    "read_forbidden": [".env*", "*.pem", "*.key"],
    "forbidden": ["pilot/*", "relais/*", "tests/**"]
  },

  "acceptance": [
    "runGuardrailPreflight returns PreflightResult with ok or stopCode",
    "Branch mismatch returns STOP_BRANCH_MISMATCH",
    "Identical fingerprint to last_failed returns STOP_REDISPATCH_IDENTICAL_TASK",
    "Dirty worktree returns STOP_MERGE_DIRTY_WORKTREE (or BLOCKED_DIRTY_WORKTREE)",
    "pnpm build succeeds"
  ],

  "verify": ["pnpm build"],
  "risk": "MED",
  "notes": [
    "Uses existing git utilities from src/lib/git.ts if available",
    "Preflight runs BEFORE verify commands"
  ]
}
