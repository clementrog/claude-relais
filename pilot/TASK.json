{
  "v": 5,
  "id": "WP-053",
  "milestone": "M6",
  "goal": "Implement BLOCKED.json generation for preflight failures",

  "context": {
    "why": "When runner cannot safely start (missing config, dirty worktree, lock held, etc.), it must write BLOCKED.json explaining the exact remediation required. This helps users understand why the tick cannot proceed.",
    "deps": [],
    "extract": "From PRD: BLOCKED = 'cannot safely start'. Runner must write BLOCKED.json explaining exact remediation. Codes: BLOCKED_BUDGET_EXHAUSTED, BLOCKED_DIRTY_WORKTREE, BLOCKED_LOCK_HELD, BLOCKED_CRASH_RECOVERY_REQUIRED, BLOCKED_ORCHESTRATOR_OUTPUT_INVALID, BLOCKED_HISTORY_CAP_CLEANUP_REQUIRED, BLOCKED_MISSING_CONFIG."
  },

  "subtasks": [
    "1. Create src/types/blocked.ts with BlockedData interface",
    "2. Create src/lib/blocked.ts module for BLOCKED.json generation",
    "3. Implement buildBlockedData(code, reason, remediation): constructs BlockedData",
    "4. Implement writeBlocked(data, path): writes BLOCKED.json atomically",
    "5. Define remediation messages for each BLOCKED code",
    "6. Export from src/lib/index.ts"
  ],

  "implementation": {
    "BlockedData_interface": {
      "blocked_at": "string - ISO datetime",
      "code": "string - BLOCKED_* code",
      "reason": "string - human-readable explanation",
      "remediation": "string - what user should do to fix"
    },
    "blocked_codes": [
      "BLOCKED_MISSING_CONFIG - relais.config.json missing or unreadable",
      "BLOCKED_DIRTY_WORKTREE - uncommitted changes in worktree",
      "BLOCKED_LOCK_HELD - another process holds the lock",
      "BLOCKED_CRASH_RECOVERY_REQUIRED - manual cleanup needed",
      "BLOCKED_BUDGET_EXHAUSTED - milestone budgets exceeded",
      "BLOCKED_HISTORY_CAP_CLEANUP_REQUIRED - history > max_runs",
      "BLOCKED_ORCHESTRATOR_OUTPUT_INVALID - orchestrator returned invalid JSON after retry"
    ]
  },

  "scope": {
    "write": ["src/types/blocked.ts", "src/lib/blocked.ts", "src/lib/index.ts"],
    "create_under": ["src/types/", "src/lib/"],
    "read_forbidden": [".env*", "*.pem", "*.key"],
    "forbidden": ["pilot/*", "relais/*", "package.json"]
  },

  "acceptance": [
    "BlockedData interface defined with required fields",
    "buildBlockedData constructs complete blocked data",
    "writeBlocked uses atomic write",
    "Each BLOCKED code has a corresponding remediation message",
    "pnpm build succeeds"
  ],

  "verify": ["pnpm build"],
  "risk": "LOW",
  "notes": [
    "BLOCKED.json is written when tick cannot start",
    "Remediation messages should be actionable"
  ]
}
