{
  "v": 5,
  "id": "WP-032",
  "milestone": "M4",
  "goal": "Enforce turn limits for builder invocations",

  "context": {
    "why": "Builder should not exceed configured max_turns. Task-specified max_turns must be validated against config limits (min 1, max config.builder.claude_code.max_turns). Track actual turns used if available.",
    "deps": ["WP-030", "WP-031"],
    "extract": "From PRD: max_turns bounded (config), minimum 1, maximum 40 per schema. Hard caps on turns and prompt size."
  },

  "subtasks": [
    "1. Add turn limit validation in runBuilder before invocation",
    "2. Validate task.builder.max_turns >= 1",
    "3. Cap task.builder.max_turns to config.builder.claude_code.max_turns if exceeded",
    "4. Add turnsUsed field to BuilderInvocationResult (parsed from raw response if available)",
    "5. Add turnsRequested field to BuilderInvocationResult for tracking",
    "6. Log warning when task turns are capped"
  ],

  "implementation": {
    "validation_flow": [
      "1. Get task.builder.max_turns (requested turns)",
      "2. Clamp to range [1, config.builder.claude_code.max_turns]",
      "3. Log warning if clamping occurred",
      "4. Use clamped value for --max-turns CLI arg",
      "5. After invocation, extract num_turns from raw response if present"
    ],
    "BuilderInvocationResult_update": {
      "turnsRequested": "number - the turns requested by task (before clamping)",
      "turnsUsed": "number | null - actual turns used (from raw response, if available)"
    },
    "raw_response_parsing": "Claude CLI JSON response may include num_turns field - extract if present"
  },

  "scope": {
    "write": ["src/runner/builder.ts"],
    "create_under": [],
    "read_forbidden": [".env*", "*.pem", "*.key"],
    "forbidden": ["pilot/*", "relais/*", "package.json"]
  },

  "acceptance": [
    "task.builder.max_turns is validated against config limits",
    "max_turns capped to config.builder.claude_code.max_turns if exceeded",
    "Warning logged when turns are capped",
    "BuilderInvocationResult includes turnsRequested and turnsUsed fields",
    "pnpm build succeeds"
  ],

  "verify": ["pnpm build"],
  "risk": "LOW",
  "notes": [
    "Claude CLI response format: { result: string, num_turns?: number, ... }",
    "turnsUsed may be null if not available in response"
  ]
}
