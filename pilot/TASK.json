{
  "v": 5,
  "id": "WP-044",
  "milestone": "M5",
  "goal": "Implement parameter validation with metachar rejection for verification commands",

  "context": {
    "why": "Before executing verification commands, parameters must be validated to prevent injection attacks. Reject params with shell metacharacters, '..' path traversal, whitespace, or excessive length.",
    "deps": ["WP-043"],
    "extract": "From PRD: Runner expands params with strict validation: max length, no whitespace, no '..' path segments, reject shell metacharacters via regex. If param fails validation → STOP(STOP_VERIFY_TAINTED)."
  },

  "subtasks": [
    "1. Add validateParam function to src/lib/verify.ts",
    "2. Create ParamValidationResult interface with ok, error details",
    "3. Check param length against config.verification.max_param_len",
    "4. Check for whitespace if config.verification.reject_whitespace_in_params",
    "5. Check for '..' if config.verification.reject_dotdot",
    "6. Check against config.verification.reject_metachars_regex",
    "7. Create validateVerificationParams to validate all params for a task",
    "8. Export new functions from src/lib/index.ts"
  ],

  "implementation": {
    "ParamValidationResult_interface": {
      "ok": "boolean - true if all params valid",
      "errors": "ParamValidationError[] - list of validation failures"
    },
    "ParamValidationError_interface": {
      "param_name": "string - name of the parameter",
      "value": "string - the invalid value",
      "reason": "string - why it failed (too_long, whitespace, dotdot, metachar)"
    },
    "validation_checks": [
      "1. Length check: value.length > max_param_len",
      "2. Whitespace check: /\\s/ if reject_whitespace_in_params",
      "3. Path traversal check: /\\.\\.\\/|^\\.\\.$|\\/\\.\\.$/  if reject_dotdot",
      "4. Metachar check: new RegExp(reject_metachars_regex)"
    ]
  },

  "scope": {
    "write": ["src/lib/verify.ts", "src/lib/index.ts"],
    "create_under": [],
    "read_forbidden": [".env*", "*.pem", "*.key"],
    "forbidden": ["pilot/*", "relais/*", "package.json"]
  },

  "acceptance": [
    "validateParam detects params exceeding max_param_len",
    "validateParam detects whitespace in params",
    "validateParam detects '..' path traversal",
    "validateParam detects shell metacharacters",
    "validateVerificationParams validates all task params",
    "Returns ok=true when all params are valid",
    "pnpm build succeeds"
  ],

  "verify": ["pnpm build"],
  "risk": "MED",
  "notes": [
    "Default metachar regex from config: [;&|$\\\\><(){}\\[\\]`\\n\\r\\t\\0]",
    "This is a security-critical function - be thorough"
  ]
}
