{
  "v": 5,
  "id": "WP-071",
  "milestone": "M8",
  "goal": "Implement Codex CLI wrapper for reviewer invocation",

  "context": {
    "why": "The reviewer uses Codex CLI to call a 'Second Brain' model. This wrapper handles invocation, auth detection, output parsing, and graceful failure handling.",
    "deps": ["WP-070"],
    "extract": "From PRD Appendix C6: Codex CLI invocation with system+user prompts, output parsing (JSON wrapper with result string, or direct JSON), auth failure handling. If reviewer fails, append reviewer_error to report and degrade gracefully."
  },

  "subtasks": [
    "1. Create src/lib/reviewer.ts with CodexCliWrapper",
    "2. Implement invokeReviewer(config, context) -> ReviewerResult | ReviewerError",
    "3. Implement output parsing: try wrapper.result, then direct JSON, validate against schema",
    "4. Implement auth detection: check CODEX_API_KEY env var presence",
    "5. Add ReviewerResult and ReviewerError types to src/types/reviewer.ts",
    "6. Export from src/lib/index.ts and src/types/index.ts"
  ],

  "implementation": {
    "files": {
      "src/lib/reviewer.ts": "invokeReviewer, parseReviewerOutput, checkReviewerAuth",
      "src/types/reviewer.ts": "ReviewerResult, ReviewerError, ReviewerContext types"
    },
    "cli_contract": "codex -p <prompt> --model <model> --max-turns 1",
    "output_parsing": "1) parse stdout as JSON, 2) if has .result string, parse that, 3) validate against reviewer_result schema"
  },

  "scope": {
    "write": ["src/lib/reviewer.ts", "src/types/reviewer.ts", "src/lib/index.ts", "src/types/index.ts"],
    "create_under": ["src/lib/", "src/types/"],
    "read_forbidden": [".env*", "*.pem", "*.key"],
    "forbidden": ["pilot/*", "relais/*", "tests/**"]
  },

  "acceptance": [
    "invokeReviewer function implemented with spawn (shell:false)",
    "Output parsing handles both wrapper.result and direct JSON",
    "Auth check returns status based on CODEX_API_KEY presence",
    "Graceful error handling returns ReviewerError on failure",
    "Types exported correctly",
    "pnpm build succeeds"
  ],

  "verify": ["pnpm build"],
  "risk": "MED",
  "notes": [
    "Similar pattern to src/lib/claude.ts but for Codex CLI",
    "Reviewer is read-only, never modifies files",
    "Auth check is best-effort (env var presence only for V1)"
  ]
}
