{
  "v": 5,
  "id": "WP-082",
  "milestone": "M9",
  "goal": "Add guardrail fields to STATE.json types",

  "context": {
    "why": "STATE.json needs to track task fingerprints, failure streaks, verify history, and escalation state for guardrail enforcement.",
    "deps": ["WP-081"],
    "extract": "From Guardrails spec: task_fingerprint (current), last_failed_fingerprint, failure_streak (int), verify_history (array of {ts, task, result, cmd, ms}), escalation (mode, reason, window_ticks, max_stops_in_window)."
  },

  "subtasks": [
    "1. Add VerifyHistoryEntry interface to src/types/state.ts",
    "2. Add EscalationState interface (mode, reason, window_ticks, max_stops_in_window)",
    "3. Add task_fingerprint, last_failed_fingerprint, failure_streak fields to StateData",
    "4. Add verify_history and escalation fields to StateData",
    "5. Add helper functions for updating fingerprint and failure_streak",
    "6. Export types from src/types/index.ts"
  ],

  "implementation": {
    "types": {
      "VerifyHistoryEntry": "{ ts: string, task: string, result: 'PASS'|'FAIL'|'TIMEOUT', cmd: string, ms: number }",
      "EscalationState": "{ mode: 'none'|'reviewer'|'human', reason: string, window_ticks: number, max_stops_in_window: number }"
    },
    "state_fields": {
      "task_fingerprint": "Current TASK fingerprint (sha256)",
      "last_failed_fingerprint": "Fingerprint of last failed task",
      "failure_streak": "Consecutive failures count",
      "verify_history": "Last N verify results",
      "escalation": "Current escalation state"
    }
  },

  "scope": {
    "write": ["src/types/state.ts", "src/lib/state.ts", "src/types/index.ts", "src/lib/index.ts"],
    "create_under": [],
    "read_forbidden": [".env*", "*.pem", "*.key"],
    "forbidden": ["pilot/*", "relais/*", "tests/**"]
  },

  "acceptance": [
    "VerifyHistoryEntry and EscalationState interfaces defined",
    "StateData has fingerprint and failure tracking fields",
    "Helper functions for fingerprint/failure management",
    "verify_history capped to last 50 entries",
    "pnpm build succeeds"
  ],

  "verify": ["pnpm build"],
  "risk": "LOW",
  "notes": [
    "Extends existing GuardrailState from WP-075",
    "All new fields are optional for backwards compatibility"
  ]
}
