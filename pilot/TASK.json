{
  "v": 5,
  "id": "WP-075",
  "milestone": "M8",
  "goal": "Add guardrail fields to STATE.json types",

  "context": {
    "why": "STATE.json needs to track guardrail state: force_patch_until_success flag, last_risk_flags, and stop_history for repeated STOP detection.",
    "deps": ["WP-074"],
    "extract": "From PRD Appendix C8: Add guardrail object to STATE with force_patch_until_success (bool), last_risk_flags (string[]), stop_history (array of {run_id, code, at})."
  },

  "subtasks": [
    "1. Add GuardrailState interface to src/types/state.ts",
    "2. Add StopHistoryEntry interface (run_id, code, at timestamp)",
    "3. Add optional guardrail field to StateData interface",
    "4. Export new types from src/types/index.ts",
    "5. Add helper functions to src/lib/state.ts for updating guardrail state"
  ],

  "implementation": {
    "types": {
      "StopHistoryEntry": "{ run_id: string, code: string, at: string }",
      "GuardrailState": "{ force_patch_until_success: boolean, last_risk_flags: string[], stop_history: StopHistoryEntry[] }"
    },
    "helpers": {
      "appendStopHistory": "Add entry, cap to 50 entries",
      "clearForcePatch": "Set force_patch_until_success=false on success",
      "setForcePatch": "Set force_patch_until_success=true"
    }
  },

  "scope": {
    "write": ["src/types/state.ts", "src/lib/state.ts", "src/types/index.ts", "src/lib/index.ts"],
    "create_under": [],
    "read_forbidden": [".env*", "*.pem", "*.key"],
    "forbidden": ["pilot/*", "relais/*", "tests/**"]
  },

  "acceptance": [
    "GuardrailState and StopHistoryEntry interfaces defined",
    "StateData has optional guardrail?: GuardrailState field",
    "appendStopHistory caps at 50 entries",
    "clearForcePatch and setForcePatch helpers work",
    "Types exported correctly",
    "pnpm build succeeds"
  ],

  "verify": ["pnpm build"],
  "risk": "LOW",
  "notes": [
    "guardrail is optional - absent means no escalation state",
    "stop_history capped to prevent unbounded growth"
  ]
}
