{
  "v": 5,
  "id": "WP-040",
  "milestone": "M5",
  "goal": "Implement git diff analysis to compute touched set for Judge phase",

  "context": {
    "why": "Judge needs to compute the 'touched set' (all files modified by builder) to enforce scope rules and diff limits. This is based on git reality, not builder's self-report.",
    "deps": ["WP-012"],
    "extract": "From PRD Section 10: Touched set = tracked (git diff --name-status base_commit..HEAD) + untracked (git status --porcelain). Compute files_touched, lines_added, lines_deleted, new_files."
  },

  "subtasks": [
    "1. Create src/lib/diff.ts module for diff analysis functions",
    "2. Implement getTouchedTracked(baseCommit): get files from git diff --name-status",
    "3. Implement getTouchedUntracked(): get new/modified untracked files from git status --porcelain",
    "4. Implement getDiffStats(baseCommit): get lines added/deleted from git diff --numstat",
    "5. Create DiffAnalysis interface with files_touched, lines_added, lines_deleted, new_files, touched_paths",
    "6. Implement analyzeDiff(baseCommit): returns full DiffAnalysis",
    "7. Export from src/lib/index.ts"
  ],

  "implementation": {
    "DiffAnalysis_interface": {
      "files_touched": "number - total files in touched set",
      "lines_added": "number - total lines added",
      "lines_deleted": "number - total lines deleted",
      "new_files": "number - count of newly created files",
      "touched_paths": "string[] - all paths in touched set (tracked + untracked)"
    },
    "git_commands": {
      "tracked_changes": "git diff --name-status <base_commit>..HEAD",
      "untracked_files": "git status --porcelain (filter lines starting with ?? or A)",
      "line_stats": "git diff --numstat <base_commit>..HEAD"
    },
    "notes": [
      "Use execGitCommand from src/lib/git.ts for git operations",
      "Parse name-status output: A=added, M=modified, D=deleted, R=renamed",
      "Parse numstat output: lines_added lines_deleted filename (tab-separated)",
      "Handle binary files in numstat (shows - - instead of numbers)"
    ]
  },

  "scope": {
    "write": ["src/lib/diff.ts", "src/lib/index.ts"],
    "create_under": ["src/lib/"],
    "read_forbidden": [".env*", "*.pem", "*.key"],
    "forbidden": ["pilot/*", "relais/*", "package.json"]
  },

  "acceptance": [
    "getTouchedTracked returns array of paths changed since base commit",
    "getTouchedUntracked returns array of new untracked files",
    "getDiffStats returns lines added and deleted",
    "analyzeDiff returns complete DiffAnalysis object",
    "Functions handle empty diff gracefully",
    "pnpm build succeeds"
  ],

  "verify": ["pnpm build"],
  "risk": "LOW",
  "notes": [
    "This is the foundation for scope enforcement in WP-041",
    "baseCommit will come from TickState (tracked as base_commit_sha)"
  ]
}
