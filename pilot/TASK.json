{
  "v": 5,
  "id": "WP-073",
  "milestone": "M8",
  "goal": "Implement risk scoring and reviewer trigger logic",

  "context": {
    "why": "Reviewer should only be called on risky situations to avoid unnecessary cost. Risk scoring uses deterministic signals: high_risk_globs, diff_fraction_threshold, repeated_stop history.",
    "deps": ["WP-072"],
    "extract": "From PRD Appendix C4: Risk triggers include (1) allowed_globs overlap high_risk_globs, (2) touched path matches high_risk_globs, (3) diff fraction >= threshold, (4) repeated STOPs in window, (5) verify failure with on_verify_fail=true. Returns risk_flags array."
  },

  "subtasks": [
    "1. Create src/lib/risk.ts with computeRiskFlags function",
    "2. Implement shouldTriggerReviewer(config, riskFlags) -> boolean",
    "3. Implement checkHighRiskGlobs(paths, highRiskGlobs) -> string[]",
    "4. Implement checkDiffFraction(analysis, limits, threshold) -> boolean",
    "5. Implement checkRepeatedStops(stopHistory, window, maxStops) -> boolean",
    "6. Add RiskFlags type to src/types/reviewer.ts",
    "7. Export from src/lib/index.ts"
  ],

  "implementation": {
    "functions": {
      "computeRiskFlags": "Returns RiskFlags with high_risk_path, diff_near_cap, verify_failed, repeated_stop flags",
      "shouldTriggerReviewer": "True if any trigger condition met and reviewer.enabled",
      "checkHighRiskGlobs": "Uses micromatch to check paths against high_risk_globs",
      "checkDiffFraction": "files_touched/max or lines_changed/max >= threshold",
      "checkRepeatedStops": "Count STOPs in stop_history within window"
    },
    "risk_flags": ["high_risk_path", "diff_near_cap", "verify_failed", "repeated_stop", "budget_warning"]
  },

  "scope": {
    "write": ["src/lib/risk.ts", "src/types/reviewer.ts", "src/lib/index.ts"],
    "create_under": ["src/lib/"],
    "read_forbidden": [".env*", "*.pem", "*.key"],
    "forbidden": ["pilot/*", "relais/*", "tests/**"]
  },

  "acceptance": [
    "computeRiskFlags returns array of triggered risk flag strings",
    "shouldTriggerReviewer checks all trigger conditions from config",
    "High risk glob matching uses micromatch",
    "Diff fraction calculation is correct",
    "Stop history window check works",
    "pnpm build succeeds"
  ],

  "verify": ["pnpm build"],
  "risk": "MED",
  "notes": [
    "Risk scoring is pure/deterministic - no side effects",
    "Uses existing micromatch dependency from scope.ts"
  ]
}
