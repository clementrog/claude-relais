{
  "v": 5,
  "id": "WP-052",
  "milestone": "M6",
  "goal": "Implement history snapshots for tick run artifacts",

  "context": {
    "why": "Each tick's artifacts (report.json, report.md, diff.patch, verify.log) must be preserved in history/<run_id>/. This enables debugging and audit trails. Cap enforced only at preflight.",
    "deps": ["WP-050", "WP-051"],
    "extract": "From PRD Section 14: History snapshots are kept at history/<run_id>/{meta.json, report.json, report.md, diff.patch, verify.log}. History cap enforced at preflight only."
  },

  "subtasks": [
    "1. Create src/lib/history.ts module for history management",
    "2. Implement createHistorySnapshot(runId, config): creates history/<run_id>/ directory",
    "3. Implement writeHistoryArtifact(runId, filename, content): writes artifact to history",
    "4. Implement snapshotRun(runId, report, markdown, diffPatch, verifyLog): saves all artifacts",
    "5. Create meta.json with run_id, created_at, verdict, code",
    "6. Implement getHistoryCount(config): counts existing history entries",
    "7. Export from src/lib/index.ts"
  ],

  "implementation": {
    "history_structure": {
      "path": "relais/history/<run_id>/",
      "files": [
        "meta.json - run_id, created_at, verdict, code",
        "report.json - full report data",
        "report.md - markdown rendering",
        "diff.patch - git diff patch (optional)",
        "verify.log - verification output (optional)"
      ]
    },
    "meta_json": {
      "run_id": "string",
      "created_at": "string (ISO datetime)",
      "verdict": "success | stop | blocked",
      "code": "string"
    }
  },

  "scope": {
    "write": ["src/lib/history.ts", "src/lib/index.ts"],
    "create_under": ["src/lib/"],
    "read_forbidden": [".env*", "*.pem", "*.key"],
    "forbidden": ["pilot/*", "relais/*", "package.json"]
  },

  "acceptance": [
    "createHistorySnapshot creates directory structure",
    "snapshotRun writes all artifacts to history/<run_id>/",
    "meta.json contains correct metadata",
    "Optional artifacts (diff.patch, verify.log) handled gracefully",
    "getHistoryCount returns accurate count",
    "pnpm build succeeds"
  ],

  "verify": ["pnpm build"],
  "risk": "LOW",
  "notes": [
    "History cap checking is done in preflight (WP-013), not here",
    "Use atomic writes where possible for crash safety"
  ]
}
