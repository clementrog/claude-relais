{
  "v": 5,
  "id": "WP-084",
  "milestone": "M9",
  "goal": "Implement verify result classification",

  "context": {
    "why": "Verify commands need proper classification into PASS/FAIL/TIMEOUT with corresponding STOP code mapping. Timeouts must map to STOP_VERIFY_FLAKY_OR_TIMEOUT.",
    "deps": ["WP-083"],
    "extract": "From Guardrails spec RUN-02: Verify produces PASS (exit 0 within timeout), FAIL (exit != 0), TIMEOUT (exceeded timeout). TIMEOUT always maps to STOP_VERIFY_FLAKY_OR_TIMEOUT and increments failure_streak."
  },

  "subtasks": [
    "1. Add VerifyResultType type ('PASS' | 'FAIL' | 'TIMEOUT') to src/types/state.ts if not exists",
    "2. Create classifyVerifyResult function in src/lib/guardrails.ts",
    "3. Map exit code + timeout flag to result type",
    "4. Map result type to STOP code (TIMEOUT -> STOP_VERIFY_FLAKY_OR_TIMEOUT)",
    "5. Return classification with stopCode and shouldIncrementFailureStreak",
    "6. Export from src/lib/index.ts"
  ],

  "implementation": {
    "function": "classifyVerifyResult(exitCode: number, timedOut: boolean, durationMs: number) -> VerifyClassification",
    "classification": {
      "PASS": "exitCode === 0 && !timedOut",
      "FAIL": "exitCode !== 0 && !timedOut",
      "TIMEOUT": "timedOut === true"
    },
    "stop_mapping": {
      "PASS": "null (no stop)",
      "FAIL": "STOP_VERIFY_FAILED_FAST or STOP_VERIFY_FAILED_SLOW",
      "TIMEOUT": "STOP_VERIFY_FLAKY_OR_TIMEOUT"
    }
  },

  "scope": {
    "write": ["src/lib/guardrails.ts", "src/lib/index.ts"],
    "create_under": [],
    "read_forbidden": [".env*", "*.pem", "*.key"],
    "forbidden": ["pilot/*", "relais/*", "tests/**"]
  },

  "acceptance": [
    "classifyVerifyResult returns VerifyClassification",
    "Exit 0 within timeout -> PASS",
    "Exit != 0 within timeout -> FAIL",
    "Timeout -> TIMEOUT with STOP_VERIFY_FLAKY_OR_TIMEOUT",
    "Classification includes shouldIncrementFailureStreak flag",
    "pnpm build succeeds"
  ],

  "verify": ["pnpm build"],
  "risk": "LOW",
  "notes": [
    "TIMEOUT always increments failure_streak",
    "FAIL may or may not increment based on config"
  ]
}
