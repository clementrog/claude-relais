{
  "v": 5,
  "id": "WP-030",
  "milestone": "M4",
  "goal": "Implement builder invocation with bypassPermissions and allowedTools",

  "context": {
    "why": "The builder (Hands) executes tasks proposed by the orchestrator. It runs with restricted tools and bypassPermissions mode.",
    "deps": ["WP-020", "WP-021"],
    "extract": "From PRD Section 9: Builder uses --permission-mode bypassPermissions, --allowedTools 'Read,Edit,Glob,Grep,Bash', --max-turns bounded. Must output JSON matching builder_result.schema.json."
  },

  "subtasks": [
    "1. Create src/types/builder.ts with BuilderResult interface matching builder_result.schema.json",
    "2. Create src/runner/builder.ts with runBuilder function",
    "3. Implement buildBuilderPrompt() to construct the user prompt from Task",
    "4. Load builder prompt templates from relais/prompts/",
    "5. Invoke Claude Code with bypassPermissions mode and allowedTools",
    "6. Parse builder output (flexible - may not be valid JSON)",
    "7. Wire into tick.ts BUILD phase",
    "8. Export from index files"
  ],

  "implementation": {
    "BuilderResult": {
      "note": "Match builder_result.schema.json",
      "fields": {
        "summary": "string - what was done",
        "files_intended": "string[] - files the builder intended to modify",
        "commands_ran": "string[] - commands executed",
        "notes": "string[] - additional notes"
      }
    },
    "runBuilder": {
      "signature": "async function runBuilder(state: TickState, task: Task): Promise<BuilderInvocationResult>",
      "behavior": [
        "1. Load system prompt from config.builder.claude_code.system_prompt_file",
        "2. Build user prompt with task details and scope reminders",
        "3. Invoke Claude Code with bypassPermissions, allowedTools, max_turns",
        "4. Parse response (try JSON, but don't fail if invalid - per config.builder.claude_code.strict_builder_json)",
        "5. Return BuilderInvocationResult with success/failure"
      ]
    },
    "BuilderInvocationResult": {
      "success": "boolean",
      "result": "BuilderResult | null",
      "rawResponse": "string",
      "durationMs": "number",
      "builderOutputValid": "boolean - whether output was valid JSON"
    },
    "allowedTools": "Read,Edit,Glob,Grep,Bash"
  },

  "scope": {
    "write": ["src/runner/tick.ts"],
    "create_under": ["src/types", "src/runner"],
    "read_forbidden": [".env*", "*.pem", "*.key"],
    "forbidden": ["pilot/*", "relais/*", "package.json"]
  },

  "acceptance": [
    "src/types/builder.ts exists with BuilderResult interface",
    "src/runner/builder.ts exists with runBuilder function",
    "Builder is invoked with bypassPermissions and allowedTools",
    "BUILD phase in tick.ts calls runBuilder",
    "pnpm build succeeds"
  ],

  "verify": ["pnpm build"],
  "risk": "MED",
  "notes": [
    "Builder output parsing should be lenient (strict_builder_json=false by default)",
    "bypassPermissions is dangerous - safety comes from scope enforcement in Judge phase"
  ]
}
