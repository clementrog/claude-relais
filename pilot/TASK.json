{
  "v": 5,
  "id": "WP-085",
  "milestone": "M9",
  "goal": "Implement escalation logic (shouldEscalate, 2-failure gate)",

  "context": {
    "why": "After 2 failures or repeated STOPs in window, must escalate to reviewer/human instead of allowing a third normal retry.",
    "deps": ["WP-084"],
    "extract": "From Guardrails spec ORCH-02: When failure_streak >= 2, orchestrator must not dispatch third normal retry. Instead escalate. RUN-04: If STOPs in last stop_window_ticks >= max_stops_in_window, set escalation.mode."
  },

  "subtasks": [
    "1. Create shouldEscalate function in src/lib/guardrails.ts",
    "2. Check failure_streak >= 2 -> escalate",
    "3. Check stop_history window (count STOPs in last N ticks)",
    "4. Check risk level (MED/HIGH may have stricter thresholds)",
    "5. Return EscalationDecision with mode (none/reviewer/human) and reason",
    "6. Export from src/lib/index.ts"
  ],

  "implementation": {
    "function": "shouldEscalate(state, config) -> EscalationDecision",
    "triggers": [
      "failure_streak >= 2",
      "stop_history count in window >= max_stops_in_window",
      "MED/HIGH task with verify failure"
    ],
    "return_type": "EscalationDecision = { mode: 'none'|'reviewer'|'human', reason: string }"
  },

  "scope": {
    "write": ["src/lib/guardrails.ts", "src/lib/index.ts"],
    "create_under": [],
    "read_forbidden": [".env*", "*.pem", "*.key"],
    "forbidden": ["pilot/*", "relais/*", "tests/**"]
  },

  "acceptance": [
    "shouldEscalate returns EscalationDecision",
    "failure_streak >= 2 triggers escalation",
    "Stop window threshold triggers escalation",
    "Mode is reviewer if enabled, else human",
    "Reason string explains why escalation triggered",
    "pnpm build succeeds"
  ],

  "verify": ["pnpm build"],
  "risk": "MED",
  "notes": [
    "Integrates with existing checkRepeatedStops from risk.ts",
    "Escalation prevents infinite retry loops"
  ]
}
