{
  "v": 5,
  "id": "WP-080",
  "milestone": "M9",
  "goal": "Implement task fingerprint (canonicalizeTask + sha256)",

  "context": {
    "why": "Task fingerprint is used to detect identical re-dispatch loops. If orchestrator 'retries' without changing the plan, fingerprint stays same and runner stops.",
    "deps": ["WP-077"],
    "extract": "From Guardrails spec: Fingerprint inputs include TASK.goal, subtasks, scope.*, acceptance, verify, implementation, risk, notes. Exclude TASK.id. Use sha256(canonical_json_string). Canonical JSON has stable key order, trimmed strings."
  },

  "subtasks": [
    "1. Create src/lib/fingerprint.ts with canonicalizeTask function",
    "2. Implement stable key ordering (sorted alphabetically)",
    "3. Implement string trimming in canonical form",
    "4. Implement computeFingerprint(task) -> sha256 hex string",
    "5. Exclude task_id from fingerprint computation",
    "6. Export from src/lib/index.ts"
  ],

  "implementation": {
    "functions": {
      "canonicalizeTask": "Returns canonical JSON string with sorted keys, trimmed strings, task_id excluded",
      "computeFingerprint": "Returns sha256(canonicalizeTask(task)) as hex string"
    },
    "fingerprint_inputs": [
      "goal", "subtasks", "scope.write", "scope.create_under", "scope.forbidden",
      "scope.read_forbidden", "acceptance", "verify", "implementation", "risk", "notes"
    ],
    "excluded": ["task_id", "id", "v", "milestone", "context"]
  },

  "scope": {
    "write": ["src/lib/fingerprint.ts", "src/lib/index.ts"],
    "create_under": ["src/lib/"],
    "read_forbidden": [".env*", "*.pem", "*.key"],
    "forbidden": ["pilot/*", "relais/*", "tests/**"]
  },

  "acceptance": [
    "canonicalizeTask produces deterministic output (same task -> same string)",
    "Key ordering is stable (alphabetical)",
    "Whitespace/formatting differences don't change fingerprint",
    "task_id excluded from fingerprint",
    "computeFingerprint returns 64-char hex sha256",
    "pnpm build succeeds"
  ],

  "verify": ["pnpm build"],
  "risk": "LOW",
  "notes": [
    "Use Node.js crypto.createHash('sha256') for hashing",
    "This is the foundation for loop detection"
  ]
}
