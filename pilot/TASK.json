{
  "v": 5,
  "id": "WP-074",
  "milestone": "M8",
  "goal": "Integrate reviewer into tick flow with new STOP codes",

  "context": {
    "why": "Wire up the reviewer to be called pre-builder when risk is detected. Add new STOP codes for reviewer decisions (force_patch, ask_question).",
    "deps": ["WP-073"],
    "extract": "From PRD Appendix C7: Add STOP_REVIEWER_FORCED_PATCH, STOP_REVIEWER_ASK_QUESTION to report.schema.json enum. Option A (recommended): reviewer runs pre-builder on risk. If force_patch -> STOP + set guardrail flag. If ask_question -> STOP + include question in report."
  },

  "subtasks": [
    "1. Add STOP_REVIEWER_FORCED_PATCH and STOP_REVIEWER_ASK_QUESTION to src/types/report.ts StopCode enum",
    "2. Update relais/schemas/report.schema.json with new codes in the enum",
    "3. Create src/lib/reviewer-flow.ts with runReviewerIfNeeded(config, context) function",
    "4. Implement handleReviewerDecision that returns appropriate StopCode or null (proceed)",
    "5. Add reviewer_error field to ReportData type for graceful degradation",
    "6. Export from src/lib/index.ts"
  ],

  "implementation": {
    "flow": {
      "pre_builder": "If shouldTriggerReviewer -> call invokeReviewer -> handle decision",
      "force_patch": "Return STOP_REVIEWER_FORCED_PATCH, caller sets guardrail.force_patch_until_success",
      "ask_question": "Return STOP_REVIEWER_ASK_QUESTION, include question in report",
      "proceed": "Return null, continue to builder",
      "error": "Log reviewer_error, degrade gracefully (default to force_patch flag if pre-build)"
    },
    "new_stop_codes": ["STOP_REVIEWER_FORCED_PATCH", "STOP_REVIEWER_ASK_QUESTION"]
  },

  "scope": {
    "write": ["src/lib/reviewer-flow.ts", "src/types/report.ts", "src/lib/index.ts", "relais/schemas/report.schema.json"],
    "create_under": ["src/lib/"],
    "read_forbidden": [".env*", "*.pem", "*.key"],
    "forbidden": ["pilot/*", "tests/**"]
  },

  "acceptance": [
    "STOP_REVIEWER_FORCED_PATCH and STOP_REVIEWER_ASK_QUESTION in StopCode enum",
    "report.schema.json updated with new codes",
    "runReviewerIfNeeded returns ReviewerFlowResult with stopCode or proceed",
    "Graceful error handling sets reviewer_error",
    "pnpm build succeeds"
  ],

  "verify": ["pnpm build"],
  "risk": "MED",
  "notes": [
    "This is the integration layer - connects risk.ts + reviewer.ts",
    "Does not modify main tick loop yet - that's for the runner itself"
  ]
}
