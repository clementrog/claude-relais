{
  "v": 5,
  "id": "WP-077",
  "milestone": "M8",
  "goal": "Implement reviewer fixture tests R101-R104",

  "context": {
    "why": "Complete M8 with fixture tests that validate reviewer escalation behavior: force_patch triggers, ask_question handling, auth degradation, and repeated stop detection.",
    "deps": ["WP-076"],
    "extract": "From PRD Appendix C9: R101 high_risk_path_triggers_reviewer_force_patch, R102 reviewer_ask_question, R103 reviewer_missing_auth_degrades, R104 repeated_stop_triggers_reviewer."
  },

  "subtasks": [
    "1. Create tests/fixtures/R101-high-risk-force-patch.test.ts",
    "2. Create tests/fixtures/R102-reviewer-ask-question.test.ts",
    "3. Create tests/fixtures/R103-reviewer-auth-degrades.test.ts",
    "4. Create tests/fixtures/R104-repeated-stop-triggers.test.ts"
  ],

  "implementation": {
    "fixtures": {
      "R101": "Task scope includes infra/**, reviewer returns force_patch -> STOP_REVIEWER_FORCED_PATCH, builder not called",
      "R102": "Reviewer returns ask_question -> STOP_REVIEWER_ASK_QUESTION, report includes question",
      "R103": "Simulate codex CLI auth error -> reviewer_error recorded, force_patch_until_success set",
      "R104": "stop_history has >=2 stops in window -> reviewer triggered on next tick"
    },
    "test_approach": "Unit test the risk.ts and reviewer-flow.ts functions with mocked inputs"
  },

  "scope": {
    "write": ["tests/fixtures/**/*.ts"],
    "create_under": ["tests/fixtures/"],
    "read_forbidden": [".env*", "*.pem", "*.key"],
    "forbidden": ["pilot/*", "relais/*", "src/**"]
  },

  "acceptance": [
    "All 4 reviewer fixtures (R101-R104) implemented",
    "R101 tests force_patch decision -> STOP_REVIEWER_FORCED_PATCH",
    "R102 tests ask_question decision -> STOP_REVIEWER_ASK_QUESTION with question",
    "R103 tests auth failure graceful degradation",
    "R104 tests repeated stop window triggers reviewer",
    "pnpm test passes with all fixture tests"
  ],

  "verify": ["pnpm build", "pnpm test run"],
  "risk": "MED",
  "notes": [
    "This completes M8: Review Escalation",
    "Tests use mocks for Codex CLI - no actual API calls"
  ]
}
