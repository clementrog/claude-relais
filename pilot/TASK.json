{
  "v": 5,
  "id": "WP-061",
  "milestone": "M7",
  "goal": "Implement fixture tests F001-F006 for core runner behaviors",

  "context": {
    "why": "Fixture tests validate critical runner behaviors: tick limits, orchestrator output validation, side effect detection, scope enforcement. These are contract tests that ensure the runner behaves correctly.",
    "deps": ["WP-060"],
    "extract": "From PRD: F001 one_tick_limits, F002 orchestrator_invalid_json_blocks, F003 question_no_side_effects, F004 verify_only_no_side_effects, F005 scope_violation_outside_allowed, F006 forbidden_path_violation."
  },

  "subtasks": [
    "1. Create tests/fixtures/F001-tick-limits.test.ts - verify orchestrator_calls <= 2, builder_calls == 1",
    "2. Create tests/fixtures/F002-orchestrator-invalid.test.ts - invalid JSON twice -> BLOCKED_ORCHESTRATOR_OUTPUT_INVALID",
    "3. Create tests/fixtures/F003-question-side-effects.test.ts - question kind with edits -> STOP_QUESTION_SIDE_EFFECTS",
    "4. Create tests/fixtures/F004-verify-only-side-effects.test.ts - verify_only with edits -> STOP_VERIFY_ONLY_SIDE_EFFECTS",
    "5. Create tests/fixtures/F005-scope-outside-allowed.test.ts - edit outside allowed_globs -> STOP_SCOPE_VIOLATION_OUTSIDE_ALLOWED",
    "6. Create tests/fixtures/F006-forbidden-path.test.ts - edit forbidden path -> STOP_RUNNER_OWNED_MUTATION",
    "7. Create test helpers/mocks for simulating runner states"
  ],

  "implementation": {
    "fixtures": {
      "F001": "one_tick_limits - verify call counts are bounded",
      "F002": "orchestrator_invalid_json_blocks - invalid JSON blocks execution",
      "F003": "question_no_side_effects - question tasks reject side effects",
      "F004": "verify_only_no_side_effects - verify_only tasks reject side effects",
      "F005": "scope_violation_outside_allowed - out-of-scope paths detected",
      "F006": "forbidden_path_violation - runner-owned paths protected"
    },
    "test_approach": "Unit test the individual lib functions that implement these behaviors"
  },

  "scope": {
    "write": ["tests/fixtures/**/*.ts", "tests/helpers/**/*.ts"],
    "create_under": ["tests/fixtures/", "tests/helpers/"],
    "read_forbidden": [".env*", "*.pem", "*.key"],
    "forbidden": ["pilot/*", "relais/*", "src/**"]
  },

  "acceptance": [
    "All 6 fixture tests implemented",
    "Tests validate the expected STOP/BLOCKED codes",
    "Tests for scope enforcement use actual scope checking functions",
    "pnpm test passes with new fixture tests",
    "pnpm build succeeds"
  ],

  "verify": ["pnpm build", "pnpm test run"],
  "risk": "MED",
  "notes": [
    "These are primarily unit tests of the lib functions",
    "Full integration tests require mocking Claude Code CLI"
  ]
}
